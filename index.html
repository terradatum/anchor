<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <title>Anchor Modeler</title>
    <!-- web fonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <!-- styling -->
    <link href='application.css' rel='stylesheet' type='text/css'/>

    <!-- run some checks first -->
    <script type="text/javascript">
        var browser = window.navigator.userAgent;
        // check that it's not IE
        if(browser.indexOf('MSIE ') >= 0 || browser.indexOf('Trident/') >= 0)
            unsupported('Internet Explorer is not supported.');

        function unsupported(msg) {
            console.error(msg);
            // disable handlers and leave
            window.init = null;
            window.onbeforeunload = null;
            window.onunload = null;
            window.location = "unsupported.html";
        }
        // -->
    </script>

    <script type="text/javascript">
        <!--
        "use strict"; // be safe!

        var VERSION = 0.98;

        // change to false in beta
        var RELEASE = false;

        // set to true to show debugging information
        var DEBUG = false;


        var Defaults = {
            changingRange: 'datetime',
            encapsulation: 'dbo',
            identity: 'int',
            metadataPrefix: 'Metadata',
            metadataType: 'int',
            metadataUsage: 'true',
            changingSuffix: 'ChangedAt',
            identitySuffix: 'ID',
            positIdentity: 'int',
            positGenerator: 'true',
            positingRange: 'datetime',
            positingSuffix: 'PositedAt',
            positorRange: 'tinyint',
            positorSuffix: 'Positor',
            reliabilityRange: 'tinyint',
            reliabilitySuffix: 'Reliability',
            reliableCutoff: '1', // inclusive, smallest reliability considered reliable
            deleteReliability: '0', // default reliability value for deletes
            reliableSuffix: 'Reliable',
            partitioning: 'false',
            entityIntegrity: 'true',
            restatability: 'true',
            idempotency: 'false',
            assertiveness: 'true',
            naming: 'improved',
            positSuffix: 'Posit',
            annexSuffix: 'Annex',
            chronon: 'datetime2(7)',
            now: 'sysdatetime()',
            dummySuffix: 'Dummy',
            versionSuffix: 'Version',
            statementTypeSuffix: 'StatementType',
            checksumSuffix: 'Checksum',
            businessViews: 'false',
            equivalence: 'false',
            equivalentSuffix: 'EQ',
            equivalentRange: 'tinyint',
            databaseTarget: 'SQLServer',
            temporalization: 'uni'
        };

        // global function providing inheritance
        function extend(type, supertype){
            for(var member in supertype.prototype)
                if(!type.prototype[member])
                    type.prototype[member] = supertype.prototype[member];
        }

        // helpers for UTF-8, credits to Johan Sundström and the Mozilla Developer Network
        function utf8_to_b64( str ) {
            return window.btoa(unescape(encodeURIComponent( str )));
        }
        function b64_to_utf8( str ) {
            return decodeURIComponent(escape(window.atob( str )));
        }

        // available node types enumeration with textual representation
        var NodeType = {
            UNKNOWN:    0, '0': "Unknown",
            ANCHOR:     1, '1': "Anchor",
            ATTRIBUTE:  2, '2': "Attribute",
            TIE:        3, '3': "Tie",
            KNOT:       4, '4': "Knot",
            EDGE:       5, '5': "Edge",
            PARTITION:  6, '6': "Partition",
            // "static variables" masses and charges, for example NodeType.mass[NodeType.ANCHOR];
            mass:       [null, 2, 3, 5, 5, 2, null],
            charge:     [null, 1, 1, 1, 1, 4, null]
        };

        var UniqueIdentity = {
            lastId: 0,
            usedIds: [],
            nextId: function() {
                while(this.usedIds[++this.lastId]);
                this.usedIds[this.lastId] = true;
                return this.lastId;
            },
            takeId: function(id) {
                this.usedIds[id] = true;
                return id;
            }
        };

        var DataTypeConverter = {
            MATCH: 0,
            REPLACE: 1,
            SQLServer_to_Oracle: [
                // exact numbers
                [/"tinyint"/ig,                         '"NUMBER(3)"'],
                [/"smallint"/ig,                        '"NUMBER(5)"'],
                [/"int"|"integer"/ig,                   '"NUMBER(10)"'],
                [/"bigint"/ig,                          '"NUMBER(19)"'],
                [/"decimal\(([0-9]+),\s*([0-9]+)\)"/ig, '"NUMBER($1,$2)"'],
                [/"numeric\(([0-9]+),\s*([0-9]+)\)"/ig, '"NUMBER($1,$2)"'],
                [/"smallmoney"/ig,                      '"NUMBER(10,4)"'],
                [/"money"/ig,                           '"NUMBER(19,4)"'],
                // approximate numbers
                [/"real"/ig,                            '"BINARY_FLOAT"'],
                [/"float"/ig,                           '"BINARY_DOUBLE"'],
                // time types
                [/"smalldatetime"/ig,                   '"TIMESTAMP(3)"'],
                [/"datetime"/ig,                        '"TIMESTAMP(3)"'],
                [/"datetime2\(([0-9]+)\)"/ig,           '"TIMESTAMP($1)"'],
                [/"datetimeoffset\(([0-9]+)\)"/ig,      '"TIMESTAMP($1) WITH TIME ZONE"'],
                // strings
                [/"varchar\(([0-9]+)\)"/ig,             '"VARCHAR2($1)"'],
                [/"varchar\(max\)"/ig,                  '"CLOB"'],
                [/"text"/ig,                            '"LONG"'],
                // binaries
                [/"binary\(([0-9]+)\)"/ig,              '"RAW($1)"'],
                [/"varbinary\(([0-9]+)\)"/ig,           '"LONG RAW"'],
                [/"varbinary\(max\)"/ig,                '"BLOB"'],
                [/"image"/ig,                           '"LONG RAW"'],
                // other
                [/"xml"/ig,                             '"XMLTYPE"'],
                [/"bit"/ig,                             '"NUMBER(1)"'],
                [/"uniqueidentifier"/ig,                '"RAW(16)"']
            ],
            SQLServer_to_PostgreSQL: [
                [/"tinyint"/ig,                         '"smallint"'],
                [/"NUMBER\(([0-9]+)\)"/ig,              '"numeric($1)"'],
                [/"datetime"/ig,                        '"timestamp"'],
                [/"datetime2\(([0-9]+)\)"/ig,           '"timestamp($1)"'],
                [/"varchar"/ig,                         '"char(1)"'],
            ],
            PostgreSQL_to_SQLServer: [
                [/"numeric\(([0-9]+)\)"/ig,             '"NUMBER($1)"'],
                [/"timestamp"/ig,                       '"datetime"'],
                [/"timestamp\(([0-9]+)\)"/ig,           '"datetime2($1)"'],
                [/"char(1)"/ig,                         '"varchar"'],
            ],
            convert: function(xml, source, target) {
                var ruleset = this[source + '_to_' + target];
                if(!ruleset) {
                    alert('Conversion between ' + source + ' and ' + target + ' is not supported.');
                    return xml;
                }
                var str = (new XMLSerializer()).serializeToString(xml);
                var rule;
                for(var i = 0; rule = ruleset[i]; i++) {
                    str = str.replace(rule[this.MATCH], rule[this.REPLACE]);
                }
                xml = (new DOMParser()).parseFromString(str, 'text/xml');
                return xml;
            }
        };

        function ModalBackground(message) {
            var modalBackground = document.createElement('div');
            modalBackground.setAttribute("id", "modalBackground");
            modalBackground.style.width = window.innerWidth + 'px';
            modalBackground.style.height = window.innerHeight + 'px';
            this.modalBackground = modalBackground;
            if(message) {
                var text = document.createTextNode(message);
                modalBackground.appendChild(text);
            }
            document.body.appendChild(modalBackground);
            return this;
        }
        ModalBackground.prototype = {
            modalBackground: null,
            close: function(event) {
                document.body.removeChild(this.modalBackground);
            }
        };

        function URLPopover(url) {
            DrawingEngine.stop();
            var self = this;

            this.modalBackground = new ModalBackground();

            var popover = document.createElement('div');
            popover.setAttribute("id", "urlPopover");
            var wPadding = window.innerWidth * 0.1;
            var hPadding = window.innerHeight * 0.1;
            var close = document.createElement('div');
            close.className = 'closebutton';
            close.addEventListener('click', function(event) { return self.close(event); }, false);
            popover.appendChild(close);

            var content = document.createElement('iframe');
            content.setAttribute("id", "content");
            content.style.width = (window.innerWidth - 2 * wPadding) + 'px';
            content.style.height = (window.innerHeight - 2 * hPadding) + 'px';
            content.src = url;

            popover.appendChild(content);
            document.body.appendChild(popover);

            this.popover = popover;
            return this;
        }
        URLPopover.prototype = {
            popover: null,
            modalBackground: null,
            close: function(event) {
                document.body.removeChild(this.popover);
                this.modalBackground.close();
                DrawingEngine.start(false);
            }
        };

        function CodePopover(documentFragment, preformatted) {
            DrawingEngine.stop();
            var self = this;

            this.modalBackground = new ModalBackground();

            var popover = document.createElement('div');
            popover.setAttribute("id", "codePopover");
            var wPadding = window.innerWidth * 0.1;
            var hPadding = window.innerHeight * 0.1;
            var close = document.createElement('div');
            close.className = 'closebutton';
            close.addEventListener('click', function(event) { return self.close(event); }, false);
            popover.appendChild(close);

            var content = document.createElement('div');
            content.setAttribute("id", "content");
            content.setAttribute("contenteditable", "true");
            content.setAttribute("spellcheck", "false");
            if(preformatted)
                content.setAttribute("class", "preformatted");
            content.style.width = (window.innerWidth - 2 * wPadding) + 'px';
            content.style.height = (window.innerHeight - 2 * hPadding) + 'px';
            content.appendChild(documentFragment);
            popover.appendChild(content);

            document.body.appendChild(popover);

            this.popover = popover;
            return this;
        }
        CodePopover.prototype = {
            popover: null,
            modalBackground: null,
            close: function(event) {
                document.body.removeChild(this.popover);
                this.modalBackground.close();
                DrawingEngine.start(false);
            }
        };

        var Actions = {
            getDirective: function() {
                var database = Defaults.databaseTarget;
                var temporalization = Defaults.temporalization;
                var directive = database + '_' + temporalization + '.directive';
                return directive;
            },
            transform: function (xmlDocument, transformationURL, ownerDocument) {
                var result;
                var xmlhttp = new window.XMLHttpRequest();
                // Added random parameter to prevent caching...
                xmlhttp.open("GET", transformationURL + '?r=' + Math.random(), false);
                xmlhttp.send(null);
                var processor = new XSLTProcessor();
                if(xmlhttp.responseXML) {
                    processor.importStylesheet(xmlhttp.responseXML.documentElement);
                }
                else {
                    var xml = new DOMParser().parseFromString(xmlhttp.responseText, 'text/xml');
                    processor.importStylesheet(xml.documentElement);
                }
                result = processor.transformToFragment(xmlDocument, ownerDocument);
                return result;
            },
            createEmail: function(str) {
                ASKBEFOREUNLOAD = false; // prevent onbeforeunload behavior
                var save = document.createElement('a');
                var modelName = Model.name || 'Model';
                save.href = "mailto:?subject=" + modelName + "&body=" + str;
                save.target = '_self';
                var event = document.createEvent('Event');
                event.initEvent('click', true, true);
                save.dispatchEvent(event);
                (window.URL || window.webkitURL).revokeObjectURL(save.href);
            },
            saveToDisk: function (str, type) {
                var save = document.createElement('a');
                save.href = 'data:text/' + type + ',' + str;
                save.target = '_blank';
                save.download = (Model.name || 'Model') + '.' + type;
                var event = document.createEvent('Event');
                event.initEvent('click', true, true);
                save.dispatchEvent(event);
                (window.URL || window.webkitURL).revokeObjectURL(save.href);
            },
            xmlFromURL: function(url) {
                var xmlhttp = new window.XMLHttpRequest();
                xmlhttp.open("GET", url, false);
                xmlhttp.send(null);
                return xmlhttp.responseXML;
            },
            
            jsonify: function(xml) {
                var object = Sisulator.objectify(xml, Sisulator.MAP);
                // jsonify the object
                return JSON.stringify(object, null, 3);
            },
            // creates a preformatted document fragment from the given text
            preformat: function(text) {
                var fragment = document.createDocumentFragment();
                var pre = document.createElement('pre');
                pre.appendChild(document.createTextNode(text));
                fragment.appendChild(pre);
                return fragment;
            }
        };

        var Sisulator = {
            // the map defines 'keys' for elements that may occur more than once
            // on the same level in the XML document
            MAP: {
                knot: function(xml, fragment) {
                    return fragment.getAttribute('mnemonic');
                },
                anchor: function(xml, fragment) {
                    return fragment.getAttribute('mnemonic');
                },
                attribute: function(xml, fragment) {
                    return fragment.getAttribute('mnemonic');
                },
                tie: function(xml, fragment) {
                    var roles = xml.evaluate(
                            '*[@role]',
                            fragment,
                            null,
                            XPathResult.ORDERED_NODE_ITERATOR_TYPE, // document order
                            null
                    );
                    var key = '', role = roles.iterateNext();
                    while(role) {
                        key += role.getAttribute('type') + '_' + role.getAttribute('role');
                        role = roles.iterateNext();
                        if(role) key += '_';
                    }
                    return key;
                },
                anchorRole: function(xml, fragment) {
                    return fragment.getAttribute('type') + '_' + fragment.getAttribute('role');
                },
                knotRole: function(xml, fragment) {
                    return fragment.getAttribute('type') + '_' + fragment.getAttribute('role');
                }
            },
            // used to replace certain element names with others
            replacer: function(name) {
                switch(name) {
                    case 'anchorRoles':
                        return 'roles';
                    case 'knotRoles':
                        return 'roles';
                    default:
                        return name;
                }
            },
            // this function will recursively traverse the XML document and
            // create a 'hash' object that mimics the structure using the given map
            // to handle siblings using the same tag
            objectify: function(xml, map) {
                var listSuffix = 's';
                function objectifier(xmlFragment, map, object) {
                    // element node
                    if(xmlFragment.nodeType === 1) {
                        // if there are children or attributes we need a container
                        if(xmlFragment.attributes.length > 0 || xmlFragment.firstChild) {
                            if(!object[xmlFragment.nodeName])
                                object[xmlFragment.nodeName] = Object.create(null);
                            var partialObject = object[xmlFragment.nodeName];
                            if(typeof map[xmlFragment.nodeName] === 'function') {
                                var key = map[xmlFragment.nodeName](xml, xmlFragment);
                                if(key) {
                                    partialObject = partialObject[key] = Object.create(null);
                                    partialObject.id = key;
                                    var name = Sisulator.replacer(
                                            xmlFragment.nodeName + listSuffix
                                    );
                                    // reference the object from the array
                                    if(!object[name])
                                        object[name] = [];
                                    object[name].push(key);
                                }
                            }
                            // process attributes
                            if (xmlFragment.attributes.length > 0) {
                                for (var j = 0; j < xmlFragment.attributes.length; j++) {
                                    var attribute = xmlFragment.attributes.item(j);
                                    partialObject[attribute.nodeName] = attribute.nodeValue;
                                }
                            }
                            // process children
                            var child = xmlFragment.firstChild;
                            if(child) objectifier(child, map, partialObject);
                        }
                    }
                    // text node
                    else if(xmlFragment.nodeType === 3) {
                        // add content with underscore naming
                        if(xmlFragment.nodeValue)
                            object['_' + xmlFragment.parentNode.nodeName] = xmlFragment.nodeValue;
                    }
                    // process siblings
                    var sibling = xmlFragment.nextSibling;
                    if(sibling) objectifier(sibling, map, object);
                    return object;
                }
                // just initialize and return the result
                return objectifier(xml.documentElement, map, {});
            },
            sisulate: function(xml, directive) {
                // objectify the xml
                var schema = Sisulator.objectify(xml, Sisulator.MAP).schema;
                var cacheDisabler = '';
                if(DEBUG) cacheDisabler = '?r=' + Math.random();
                // this variable holds the result
                var _sisula_ = '';

                // process and evaluate all sisulas in the directive
                var xmlhttp = new window.XMLHttpRequest();
                xmlhttp.open("GET", directive + cacheDisabler, false);
                xmlhttp.send(null);
                var response = xmlhttp.responseText.replace(/\r/g, ''); // unify line breaks
                // only non-empty lines that are not comments (starts with #)
                var scripts = response.match(/^[^#].+/gm);
                var script;
                var splitter = /\/\*~([\s\S]*?)~\*\//g; // split JS /*~ sisula template ~*/ JS
                // process every sisula
                for(var s = 0; script = scripts[s]; s++) {
                    xmlhttp.open("GET", script.trim() + cacheDisabler, false);
                    xmlhttp.send(null);
                    var sisula = xmlhttp.responseText;
                    // split language into JavaScript and SQL template components
                    var sisulets = sisula.split(splitter);
                    // substitute from SQL template to JavaScript
                    for(var i = 1; i < sisulets.length; i+=2) {
                        // honor escaped dollar signs
                        sisulets[i] = sisulets[i].replace(/[$]{2}/g, '§DOLLAR§'); // escaping dollar signs
                        sisulets[i] = sisulets[i].replace(/["]{2}/g, '§QUOTED§'); // escaping double quotes
                        sisulets[i] = sisulets[i].replace(/[$]{([\S\s]*?)}[$]/g, '" + $1 + "'); // multi-expression
                        sisulets[i] = sisulets[i].replace(/[$]\(([\S\s]*?)\)\?[^\S\n]*([^:\n]*)[:]?[^\S\n]*(.*)/g, '" + ($1 ? "$2" : "$3") + "'); // conditional
                        sisulets[i] = sisulets[i].replace(/[\$]([\w.]*?)(?:([\$])|([^\w.]|$))/g, '" + ($1 ? $1 : "") + "$3'); // single
                        sisulets[i] = sisulets[i].replace(/(\r\n|\n|\r)/g, '\\n" +\n'); // line breaks
                        sisulets[i] = sisulets[i].replace(/^/gm, '"'); // start of line
                        sisulets[i] = '_sisula_+=' + sisulets[i] + '";'; // variable assignment
                    }
                    // join the parts together again (now all JavaScript)
                    sisula = sisulets.join('');
                    try {
                        if(DEBUG && console && console.log)
                            console.log(sisula);
                        // this eval needs schema and _sisula_ to be defined
                        eval(sisula);
                    }
                    catch(e) {
                        if(DEBUG && console && console.error && script)
                            console.error('The script ' + script + ' could not be executed.');
                        throw e;
                    }
                }
                _sisula_ = _sisula_.replace(/§DOLLAR§/g, '$'); // unescaping dollar signs
                _sisula_ = _sisula_.replace(/§QUOTED§/g, '"'); // unescaping double quotes
                _sisula_ = _sisula_.replace(/^\s*[\r\n]/gm, ''); // remove empty lines
                _sisula_ = _sisula_.replace(/(\S+[^\S\n])(?:[^\S\n]+)/gm, '$1'); // consume multiple spaces, but not indentation
                return _sisula_;
            }
        };

        var Settings = {
            // default values for some 'global' settings
            calculations: 'simple',
            showMnemonics: true,
            showCardinalities: true,
            init: function() {
                document.getElementById('damping').value = ((1 - LayoutEngine.damping) * 100).toFixed(0);
                document.getElementById('longRangeEffect').value = (LayoutEngine.longRangeEffect * 100).toFixed(0);
                document.getElementById('fuzziness').value = (LayoutEngine.fuzziness * 100).toFixed(0);
                document.getElementById('normalDistance').value = LayoutEngine.normalDistance.toFixed(0);
                document.getElementById('stoppingVelocity').value = LayoutEngine.stoppingVelocity.toFixed(1);
                document.getElementById('minimumStartingVelocity').value = LayoutEngine.minimumStartingVelocity.toFixed(1);
                document.getElementById('maximumStartingVelocity').value = LayoutEngine.maximumStartingVelocity.toFixed(1);
                document.getElementById('partitionFactor').value = LayoutEngine.partitionFactor.toFixed(0);
                document.getElementById('stiffness').value = LayoutEngine.stiffness.toFixed(1);
                document.getElementById('temporalization').value = Defaults.temporalization;
                document.getElementById('database').value = Defaults.databaseTarget;
                document.getElementById('miniatureFramesBetweenRefresh').value = DrawingEngine.miniatureFramesBetweenRefresh;
                document.getElementById('calculations').value = this.calculations;
                document.getElementById('encapsulation').value = Defaults.encapsulation;
                document.getElementById('defaultIdentity').value = Defaults.identity;
                document.getElementById('defaultChronon').value = Defaults.chronon;
                document.getElementById('defaultNow').value = Defaults.now;
                document.getElementById('defaultChangingRange').value = Defaults.changingRange;
                document.getElementById('restatability').checked = Defaults.restatability === 'true';
                document.getElementById('idempotency').checked = Defaults.idempotency === 'true';
                document.getElementById('metadataUsage').checked = Defaults.metadataUsage === 'true';
                document.getElementById('businessViews').checked = Defaults.businessViews === 'true';
                document.getElementById('equivalence').checked = Defaults.equivalence === 'true';
                document.getElementById('changingSuffix').value = Defaults.changingSuffix;
                document.getElementById('checksumSuffix').value = Defaults.checksumSuffix;
                document.getElementById('identitySuffix').value = Defaults.identitySuffix;
                document.getElementById('naming').value = Defaults.naming;
            },
            resetDefaults: function(warn) {
                var reset = false;
                if(warn)
                    reset = confirm(
                            "Are you sure you want to reset to default values? " +
                            "This will overwrite any changes you have made."
                    );
                else
                    reset = true;
                if(reset) {
                    this.setEncapsulation('dbo');
                    this.setDefaultIdentity('int');
                    this.setDefaultChronon('datetime2(7)');
                    this.setDefaultNow('sysdatetime()');
                    this.setDefaultChangingRange('datetime');
                    this.setMetadataPrefix('Metadata');
                    this.setMetadataType('int');
                    this.setEquivalentSuffix('EQ');
                    this.setEquivalentRange('tinyint');
                    this.setRestatability('true');
                    this.setIdempotency('false');
                    this.setAssertiveness('true');
                    this.setMetadataUsage('true');
                    this.setBusinessViews('false');
                    this.setEquivalence('false');
                    this.setChangingSuffix('ChangedAt');
                    this.setIdentitySuffix('ID');
                    this.setPositIdentityRange('int');
                    this.setPositingRange('datetime');
                    this.setPositingSuffix('PositedAt');
                    this.setPositorRange('tinyint');
                    this.setPositorSuffix('Positor');
                    this.setReliabilityRange('tinyint');
                    this.setReliabilitySuffix('Reliability');
                    this.setReliableCutoff('1');
                    this.setDeleteReliability('0');
                    this.setReliableSuffix('Reliable');
                    this.setPartitioning('false');
                    this.setEntityIntegrity('true');
                    this.setTemporalization('uni');
                    this.setDatabase('SQLServer', false);
                    this.setNaming('improved');
                    this.init();
                }
            },
            resetSettings: function(warn) {
                var reset = false;
                if(warn)
                    reset = confirm(
                            "Are you sure you want to reset to default values? " +
                            "This will overwrite any changes you have made."
                    );
                else
                    reset = true;
                if(reset) {
                    this.setDamping(4);
                    this.setLongRangeEffect(25);
                    this.setFuzziness(10);
                    this.setNormalDistance(30);
                    this.setStoppingVelocity(0.1);
                    this.setMinimumStartingVelocity(1);
                    this.setMaximumStartingVelocity(5);
                    this.setPartitionFactor(15);
                    this.setStiffness(1);
                    this.setMiniRate(50);
                    this.setCalculations('simple');
                    NodeType.mass[NodeType.KNOT] = 5;
                    NodeType.charge[NodeType.KNOT] = 1;
                    NodeType.mass[NodeType.ANCHOR] = 2;
                    NodeType.charge[NodeType.ANCHOR] = 1;
                    NodeType.mass[NodeType.ATTRIBUTE] = 3;
                    NodeType.charge[NodeType.ATTRIBUTE] = 1;
                    NodeType.mass[NodeType.TIE] = 5;
                    NodeType.charge[NodeType.TIE] = 1;
                    NodeType.mass[NodeType.EDGE] = 2;
                    NodeType.charge[NodeType.EDGE] = 4;
                    this.init();
                }
            },
            storeSettings: function(storage) {
                storage.setItem("version", VERSION);
                storage.setItem("damping", (1 - LayoutEngine.damping) * 100);
                storage.setItem("longRangeEffect", LayoutEngine.longRangeEffect * 100);
                storage.setItem("fuzziness", LayoutEngine.fuzziness * 100);
                storage.setItem("normalDistance", LayoutEngine.normalDistance);
                storage.setItem("stoppingVelocity", LayoutEngine.stoppingVelocity);
                storage.setItem("minimumStartingVelocity", LayoutEngine.minimumStartingVelocity);
                storage.setItem("maximumStartingVelocity", LayoutEngine.maximumStartingVelocity);
                storage.setItem("partitionFactor", LayoutEngine.partitionFactor);
                storage.setItem("stiffness", LayoutEngine.stiffness);
                storage.setItem("temporalization", Defaults.temporalization);
                storage.setItem("database", Defaults.databaseTarget);
                storage.setItem("miniatureFramesBetweenRefresh", DrawingEngine.miniatureFramesBetweenRefresh);
                storage.setItem("calculations", this.calculations);
                storage.setItem("encapsulation", Defaults.encapsulation);
                storage.setItem("defaultIdentity", Defaults.identity);
                storage.setItem("defaultChronon", Defaults.chronon);
                storage.setItem("defaultNow", Defaults.now);
                storage.setItem("defaultChangingRange", Defaults.changingRange);
                storage.setItem("metadataPrefix", Defaults.metadataPrefix);
                storage.setItem("metadataType", Defaults.metadataType);
                storage.setItem("equivalentSuffix", Defaults.equivalentSuffix);
                storage.setItem("equivalentRange", Defaults.equivalentRange);
                storage.setItem("metadataUsage", Defaults.metadataUsage);
                storage.setItem("businessViews", Defaults.businessViews);
                storage.setItem("equivalence", Defaults.equivalence);
                storage.setItem("restatability", Defaults.restatability);
                storage.setItem("idempotency", Defaults.idempotency);
                storage.setItem("assertiveness", Defaults.assertiveness);
                storage.setItem("changingSuffix", Defaults.changingSuffix);
                storage.setItem("identitySuffix", Defaults.identitySuffix);
                storage.setItem("positIdentity", Defaults.positIdentity);
                storage.setItem("positingRange", Defaults.positingRange);
                storage.setItem("positingSuffix", Defaults.positingSuffix);
                storage.setItem("positorRange", Defaults.positorRange);
                storage.setItem("positorSuffix", Defaults.positorSuffix);
                storage.setItem("checksumSuffix", Defaults.checksumSuffix);
                storage.setItem("reliabilityRange", Defaults.reliabilityRange);
                storage.setItem("reliabilitySuffix", Defaults.reliabilitySuffix);
                storage.setItem("reliableCutoff", Defaults.reliableCutoff);
                storage.setItem("deleteReliability", Defaults.deleteReliability);
                storage.setItem("reliableSuffix", Defaults.reliableSuffix);
                storage.setItem("partitioning", Defaults.partitioning);
                storage.setItem("entityIntegrity", Defaults.entityIntegrity);
                storage.setItem("naming", Defaults.naming);
                storage.setItem("knotMass", NodeType.mass[NodeType.KNOT]);
                storage.setItem("knotCharge", NodeType.charge[NodeType.KNOT]);
                storage.setItem("anchorMass", NodeType.mass[NodeType.ANCHOR]);
                storage.setItem("anchorCharge", NodeType.charge[NodeType.ANCHOR]);
                storage.setItem("attributeMass", NodeType.mass[NodeType.ATTRIBUTE]);
                storage.setItem("attributeCharge", NodeType.charge[NodeType.ATTRIBUTE]);
                storage.setItem("tieMass", NodeType.mass[NodeType.TIE]);
                storage.setItem("tieCharge", NodeType.charge[NodeType.TIE]);
                storage.setItem("edgeMass", NodeType.mass[NodeType.EDGE]);
                storage.setItem("edgeCharge", NodeType.charge[NodeType.EDGE]);
            },
            loadSettings: function(storage) {
                if(storage.getItem("version") != VERSION) {
                    this.resetDefaults(false);
                    this.resetSettings(false);
                }
                else {
                    this.setDamping(storage.getItem('damping') || 4);
                    this.setLongRangeEffect(storage.getItem('longRangeEffect') || 25);
                    this.setFuzziness(storage.getItem('fuzziness') || 10);
                    this.setNormalDistance(storage.getItem('normalDistance') || 30);
                    this.setStoppingVelocity(storage.getItem('stoppingVelocity') || 0.1);
                    this.setMinimumStartingVelocity(storage.getItem('minimumStartingVelocity') || 1);
                    this.setMaximumStartingVelocity(storage.getItem('maximumStartingVelocity') || 5);
                    this.setPartitionFactor(storage.getItem('partitionFactor') || 15);
                    this.setStiffness(storage.getItem('stiffness') || 1);
                    this.setDatabase(storage.getItem('database') || 'SQLServer', false);
                    this.setMiniRate(storage.getItem('miniatureFramesBetweenRefresh') || 50);
                    this.setCalculations(storage.getItem('calculations') || 'simple');
                    this.setEncapsulation(storage.getItem('encapsulation') || Defaults.encapsulation);
                    this.setDefaultIdentity(storage.getItem('defaultIdentity') || Defaults.identity);
                    this.setDefaultChronon(storage.getItem('defaultChronon') || Defaults.chronon);
                    this.setDefaultNow(storage.getItem('defaultNow') || Defaults.now);
                    this.setDefaultChangingRange(storage.getItem('defaultChangingRange') || Defaults.changingRange);
                    this.setMetadataPrefix(storage.getItem('metadataPrefix') || Defaults.metadataPrefix);
                    this.setMetadataType(storage.getItem('metadataType') || Defaults.metadataType);
                    this.setEquivalentRange(storage.getItem('equivalentRange') || Defaults.equivalentRange);
                    this.setEquivalentSuffix(storage.getItem('equivalentSuffix') || Defaults.equivalentSuffix);
                    this.setMetadataUsage(storage.getItem('metadataUsage') || Defaults.metadataUsage);
                    this.setBusinessViews(storage.getItem('businessViews') || Defaults.businessViews);
                    this.setEquivalence(storage.getItem('equivalence') || Defaults.equivalence);
                    this.setChangingSuffix(storage.getItem('changingSuffix') || Defaults.changingSuffix);
                    this.setIdentitySuffix(storage.getItem('identitySuffix') || Defaults.identitySuffix);
                    this.setPositIdentityRange(storage.getItem('positIdentity') || Defaults.positIdentity);
                    this.setPositingRange(storage.getItem('positingRange') || Defaults.positingRange);
                    this.setPositingSuffix(storage.getItem('positingSuffix') || Defaults.positingSuffix);
                    this.setPositorRange(storage.getItem('positorRange') || Defaults.positorRange);
                    this.setPositorSuffix(storage.getItem('positorSuffix') || Defaults.positorSuffix);
                    this.setChecksumSuffix(storage.getItem('checksumSuffix') || Defaults.checksumSuffix);
                    this.setReliabilityRange(storage.getItem('reliabilityRange') || Defaults.reliabilityRange);
                    this.setReliabilitySuffix(storage.getItem('reliabilitySuffix') || Defaults.reliabilitySuffix);
                    this.setReliableCutoff(storage.getItem('reliableCutoff') || Defaults.reliableCutoff);
                    this.setDeleteReliability(storage.getItem('deleteReliability') || Defaults.deleteReliability);
                    this.setReliableSuffix(storage.getItem('reliableSuffix') || Defaults.reliableSuffix);
                    this.setPartitioning(storage.getItem('partitioning') || Defaults.partitioning);
                    this.setEntityIntegrity(storage.getItem('entityIntegrity') || Defaults.entityIntegrity);
                    this.setRestatability(storage.getItem('restatability') || Defaults.restatability);
                    this.setIdempotency(storage.getItem('idempotency') || Defaults.idempotency);
                    this.setAssertiveness(storage.getItem('assertiveness') || Defaults.assertiveness);
                    this.setNaming(storage.getItem('naming') || Defaults.naming);
                    NodeType.mass[NodeType.KNOT] = 1 * storage.getItem('knotMass') || 5;
                    NodeType.charge[NodeType.KNOT] = 1 * storage.getItem('knotCharge') || 1;
                    NodeType.mass[NodeType.ANCHOR] = 1 * storage.getItem('anchorMass') || 2;
                    NodeType.charge[NodeType.ANCHOR] = 1 * storage.getItem('anchorCharge') || 1;
                    NodeType.mass[NodeType.ATTRIBUTE] = 1 * storage.getItem('attributeMass') || 3;
                    NodeType.charge[NodeType.ATTRIBUTE] = 1 * storage.getItem('attributeCharge') || 1;
                    NodeType.mass[NodeType.TIE] = 1 * storage.getItem('tieMass') || 5;
                    NodeType.charge[NodeType.TIE] = 1 * storage.getItem('tieCharge') || 1;
                    NodeType.mass[NodeType.EDGE] = 1 * storage.getItem('edgeMass') || 2;
                    NodeType.charge[NodeType.EDGE] = 1 * storage.getItem('edgeCharge') || 4;
                    // must be done after Defaults have been populated with previously stored values
                    this.setTemporalization(storage.getItem('temporalization') || 'uni');
                }
                this.init();
            },
            setPositIdentityRange: function(value) {
                Defaults.positIdentity = value;
            },
            setPositingRange: function(value) {
                Defaults.positingRange = value;
            },
            setPositingSuffix: function(value) {
                Defaults.positingSuffix = value;
            },
            setPositorRange: function(value) {
                Defaults.positorRange = value;
            },
            setPositorSuffix: function(value) {
                Defaults.positorSuffix = value;
            },
            setChecksumSuffix: function(value) {
                Defaults.checksumSuffix = value;
            },
            setReliabilityRange: function(value) {
                Defaults.reliabilityRange = value;
            },
            setReliabilitySuffix: function(value) {
                Defaults.reliabilitySuffix = value;
            },
            setReliableCutoff: function(value) {
                Defaults.reliableCutoff = value;
            },
            setDeleteReliability: function(value) {
                Defaults.deleteReliability = value;
            },
            setReliableSuffix: function(value) {
                Defaults.reliableSuffix = value;
            },
            setPartitioning: function(value) {
                Defaults.partitioning = value;
            },
            setEntityIntegrity: function(value) {
                Defaults.entityIntegrity = value;
            },
            setNaming: function(value) {
                Defaults.naming = value;
            },
            positIdentity: null,
            positingRange: null,
            positingSuffix: null,
            positorRange: null,
            positorSuffix: null,
            reliabilityRange: null,
            reliabilitySuffix: null,
            reliableCutoff: null,
            deleteReliability: null,
            reliableSuffix: null,
            partitioning: null,
            entityIntegrity: null,
            metadataPrefix: null,
            metadataType: null,
            equivalentSuffix: null,
            equivalentRange: null,
            assertiveness: null,
            addTextItem: function(item, destination, before, label, title, listener) {
                if(!this[item]) {
                    this[item] = {
                        container: document.createElement('li'),
                        input: document.createElement('input')
                    };
                    this[item].input.setAttribute('type', 'text');
                    this[item].input.setAttribute('class', 'inputDefaults');
                    this[item].input.addEventListener('blur', listener, false);
                    this[item].input.value = Defaults[item];
                    this[item].container.setAttribute('title', title);
                    this[item].container.appendChild(this[item].input);
                    this[item].container.appendChild(document.createTextNode(label));
                    destination.insertBefore(this[item].container, before);
                }
                else // update values in case settings have changed
                    this[item].input.value = Defaults[item];
            },
            addBoolItem: function(item, destination, before, label, title, listener) {
                if(!this[item]) {
                    this[item] = {
                        container: document.createElement('li'),
                        input: document.createElement('input')
                    };
                    this[item].input.setAttribute('type', 'checkbox');
                    this[item].input.setAttribute('class', 'inputDefaults');
                    this[item].input.addEventListener('change', listener, false);
                    this[item].input.checked = Defaults[item] === 'true';
                    this[item].container.setAttribute('title', title);
                    this[item].container.appendChild(this[item].input);
                    this[item].container.appendChild(document.createTextNode(label));
                    destination.insertBefore(this[item].container, before);
                }
                else // update values in case settings have changed
                    this[item].input.checked = Defaults[item] === 'true';
            },
            removeItem: function(item, from) {
                if(this[item]) {
                    this[item].container.removeChild(this[item].input);
                    from.removeChild(this[item].container);
                    this[item] = null;
                }
            },
            setTemporalization: function(value) {
                Defaults.temporalization = value;
                var temporalizationSelect = document.getElementById('temporalization');
                temporalizationSelect.value = value;
                var listOfDefaults = document.getElementById('listOfDefaults');
                var beforeItem = document.getElementById('crtSettingsBeforeHere');
                if(value === 'crt') {
                    this.addOrRemovePartitioning();
                    this.addTextItem(
                            'positIdentity', listOfDefaults, beforeItem, ' Posit identity',
                            "The 'data type' for identities of posits used throughout the implementation.",
                            function() { Settings.setPositIdentityRange(this.value); }
                    );
                    this.addTextItem(
                            'positingRange', listOfDefaults, beforeItem, ' Positing time range',
                            "The positing time (corrections) 'data type' used throughout the implementation.",
                            function() { Settings.setPositingRange(this.value); }
                    );
                    this.addTextItem(
                            'positingSuffix', listOfDefaults, beforeItem, ' Positing time suffix',
                            "The suffix used for the column storing the point in time a posit was made.",
                            function() { Settings.setPositingSuffix(this.value); }
                    );
                    this.addTextItem(
                            'positorRange', listOfDefaults, beforeItem, ' Positor range',
                            "The positor (one able to correct) 'data type' used throughout the implementation.",
                            function() { Settings.setPositorRange(this.value); }
                    );
                    this.addTextItem(
                            'positorSuffix', listOfDefaults, beforeItem, ' Positor suffix',
                            "The suffix used for the column storing the who made a posit.",
                            function() { Settings.setPositorSuffix(this.value); }
                    );
                    this.addTextItem(
                            'reliabilityRange', listOfDefaults, beforeItem, ' Reliability range',
                            "A 'data type' that can hold the desired degrees of reliability.",
                            function() { Settings.setReliabilityRange(this.value); }
                    );
                    this.addTextItem(
                            'reliabilitySuffix', listOfDefaults, beforeItem, ' Reliability suffix',
                            "The suffix used for the column storing reliability.",
                            function() { Settings.setReliabilitySuffix(this.value); }
                    );
                    this.addTextItem(
                            'reliableCutoff', listOfDefaults, beforeItem, ' Reliable cutoff',
                            "The smallest (inclusive) value of reliability to be considered reliable.",
                            function() { Settings.setReliableCutoff(this.value); }
                    );
                    this.addTextItem(
                            'deleteReliability', listOfDefaults, beforeItem, ' Delete reliability',
                            "The default value of reliability to use when deleting information.",
                            function() { Settings.setDeleteReliabilty(this.value); }
                    );
                    this.addTextItem(
                            'reliableSuffix', listOfDefaults, beforeItem, ' Reliable suffix',
                            "The suffix used for the computed column storing the boolean reliable result." +
                            "This is based on a calculation using the cutoff to determine if data is " +
                            "considered reliable or unreliable.",
                            function() { Settings.setReliableSuffix(this.value); }
                    );
                    this.addBoolItem(
                            'entityIntegrity', listOfDefaults, beforeItem, ' Ensure entity integrity',
                            "Entity integrity adds constraints ensuring that no temporal duplicates " +
                            "can co-exist for the same entity and version, that no negative recording " +
                            "time intervals can be stored, and that there are no overlapping intervals " +
                            "with respect to recording time.",
                            function() { Settings.setEntityIntegrity(this.checked ? 'true' : 'false'); }
                    );
                    this.addBoolItem(
                            'assertiveness', listOfDefaults, beforeItem, ' Assertiveness',
                            "Default for new items. Assertive items get new annex rows every time a posit " +
                            "is made with a different positing time. Non-assertive items must also have a " +
                            "different reliability.",
                            function() { Settings.setAssertiveness(this.checked ? 'true' : 'false'); }
                    );
                    Editables.setEditability(Editables.positIdentityEdit, true);
                    Editables.setEditability(Editables.positGeneratorEdit, true);
                    Editables.setEditability(Editables.assertivenessEdit, true);
                }
                else {
                    this.removeItem('positIdentity', listOfDefaults);
                    this.removeItem('positingRange', listOfDefaults);
                    this.removeItem('positingSuffix', listOfDefaults);
                    this.removeItem('positorRange', listOfDefaults);
                    this.removeItem('positorSuffix', listOfDefaults);
                    this.removeItem('reliabilityRange', listOfDefaults);
                    this.removeItem('reliabilitySuffix', listOfDefaults);
                    this.removeItem('reliableCutoff', listOfDefaults);
                    this.removeItem('deleteReliability', listOfDefaults);
                    this.removeItem('reliableSuffix', listOfDefaults);
                    this.removeItem('entityIntegrity', listOfDefaults);
                    this.removeItem('assertiveness', listOfDefaults);
                    this.addOrRemovePartitioning();
                    Editables.setEditability(Editables.positIdentityEdit, false);
                    Editables.setEditability(Editables.positGeneratorEdit, false);
                    Editables.setEditability(Editables.assertivenessEdit, false);
                }
            },
            addOrRemovePartitioning: function() {
                var listOfDefaults = document.getElementById('listOfDefaults');
                var beforeItem = document.getElementById('crtSettingsBeforeHere');
                if(Defaults.temporalization === 'crt' || Defaults.equivalence === 'true') {
                    if(!this.partitioning) {
                        this.addBoolItem(
                                'partitioning', listOfDefaults, beforeItem, ' Use partitioning',
                                "Partitioning will put currently recorded information in a separate partition " +
                                "from erased information, greatly speeding up querying in the bitemporal implementation.",
                                function() { Settings.setPartitioning(this.checked ? 'true' : 'false'); }
                        );
                    }
                }
                else
                    this.removeItem('partitioning', listOfDefaults);
            },
            setMetadataPrefix: function(value) {
                Defaults.metadataPrefix = value;
            },
            setMetadataType: function(value) {
                Defaults.metadataType = value;
            },
            setEquivalentSuffix: function(value) {
                Defaults.equivalentSuffix = value;
            },
            setEquivalentRange: function(value) {
                Defaults.equivalentRange = value;
            },
            setMetadataUsage: function(value) {
                Defaults.metadataUsage = value;
                var listOfDefaults = document.getElementById('listOfDefaults');
                var beforeItem = document.getElementById('metadataSettingsBeforeHere');
                if(value === 'true') {
                    this.addTextItem(
                            'metadataPrefix', listOfDefaults, beforeItem, ' Metadata prefix',
                            "The prefix used for the columns that store a metadata reference.",
                            function() { Settings.setMetadataPrefix(this.value); }
                    );
                    this.addTextItem(
                            'metadataType', listOfDefaults, beforeItem, ' Metadata type',
                            "The 'data type' of the metadata column.",
                            function() { Settings.setMetadataType(this.value); }
                    );
                }
                else {
                    this.removeItem('metadataPrefix', listOfDefaults);
                    this.removeItem('metadataType', listOfDefaults);
                }
            },
            setBusinessViews: function(value, userToggle) {
                Defaults.businessViews = value;
                if(userToggle && value === 'true')
                    alert(
                            "Please note that when business views are used " +
                            "descriptors must follow the same rules of uniqueness as mnemonics do, " +
                            "otherwise naming clashes may occur."
                    );
            },
            setEquivalence: function(value) {
                Defaults.equivalence = value;
                var listOfDefaults = document.getElementById('listOfDefaults');
                var beforeItem = document.getElementById('metadataSettingsBeforeHere');
                if(value === 'true') {
                    this.addTextItem(
                            'equivalentSuffix', listOfDefaults, beforeItem, ' Equivalents suffix',
                            "The suffix used for the columns that store equivalents.",
                            function() { Settings.setEquivalentSuffix(this.value); }
                    );
                    this.addTextItem(
                            'equivalentRange', listOfDefaults, beforeItem, ' Equivalents range',
                            "The 'data type' of the equivalents column.",
                            function() { Settings.setEquivalentRange(this.value); }
                    );
                    this.addOrRemovePartitioning();
                    Editables.setEditability(Editables.equivalenceEdit, true);
                }
                else {
                    this.removeItem('equivalentSuffix', listOfDefaults);
                    this.removeItem('equivalentRange', listOfDefaults);
                    this.addOrRemovePartitioning();
                    Editables.setEditability(Editables.equivalenceEdit, false);
                }
            },
            setRestatability: function(value) {
                Defaults.restatability = value;
            },
            setIdempotency: function(value) {
                Defaults.idempotency = value;
            },
            setAssertiveness: function(value) {
                Defaults.assertiveness = value;
            },
            setChangingSuffix: function(value) {
                Defaults.changingSuffix = value;
            },
            setIdentitySuffix: function(value) {
                Defaults.identitySuffix = value;
            },
            setEncapsulation: function(value) {
                Defaults.encapsulation = value;
            },
            setDefaultIdentity: function(value) {
                Defaults.identity = value;
            },
            setDefaultChronon: function(value) {
                Defaults.chronon = value;
            },
            setDefaultNow: function(value) {
                Defaults.now = value;
            },
            setDefaultChangingRange: function(value) {
                Defaults.changingRange = value;
            },
            setDamping: function(value) {
                LayoutEngine.damping = (100 - value)/100;
                LayoutEngine.init();
            },
            setLongRangeEffect: function(value) {
                LayoutEngine.longRangeEffect = value/100;
                LayoutEngine.init();
            },
            setFuzziness: function(value) {
                LayoutEngine.fuzziness = value/100;
                LayoutEngine.init();
            },
            setNormalDistance: function(value) {
                LayoutEngine.normalDistance = 1 * value;
                LayoutEngine.init();
            },
            setStoppingVelocity: function(value) {
                LayoutEngine.stoppingVelocity = 1 * value;
                LayoutEngine.init();
            },
            setMinimumStartingVelocity: function(value) {
                LayoutEngine.minimumStartingVelocity = 1 * value;
                LayoutEngine.init();
            },
            setMaximumStartingVelocity: function(value) {
                LayoutEngine.maximumStartingVelocity = 1 * value;
                LayoutEngine.init();
            },
            setPartitionFactor: function(value) {
                LayoutEngine.partitionFactor = 1 * value;
                LayoutEngine.init();
            },
            setStiffness: function(value) {
                LayoutEngine.stiffness = 1 * value;
                LayoutEngine.init();
            },
            setDatabase: function(value, convert) {
                if(convert && confirm("Would you like to convert data types to " + value + "?")) {
                    var original = Defaults.databaseTarget;
                    Defaults.databaseTarget = value;
                    var xml = DataTypeConverter.convert(Model.toXML(false), original, value);
                    Model.fromXML(xml);
                }
                Defaults.databaseTarget = value;
            },
            setMiniRate: function(value) {
                DrawingEngine.miniatureFramesBetweenRefresh = 1 * value;
            },
            toggleDebug: function () {
                DEBUG = !DEBUG;
                if(DEBUG) {
                    SVGLayer.show('debugPartitions');
                    SVGLayer.show('debug');
                }
                else {
                    SVGLayer.hide('debug');
                    SVGLayer.hide('debugPartitions');
                }
                DrawingEngine.start(false);
            },
            knotMass: null,
            knotCharge: null,
            anchorMass: null,
            anchorCharge: null,
            attributeMass: null,
            attributeCharge: null,
            tieMass: null,
            tieCharge: null,
            edgeMass: null,
            edgeCharge: null,
            setCalculations: function(value) {
                var listOfSettings = document.getElementById('listOfSettings');
                var calcsItem = document.getElementById('calcsItem');
                if(value === 'simple') {
                    LayoutEngine.layout = LayoutEngine.simpleLayout;
                    if(this.knotMass) listOfSettings.removeChild(this.knotMass);
                    if(this.knotCharge) listOfSettings.removeChild(this.knotCharge);
                    if(this.anchorMass) listOfSettings.removeChild(this.anchorMass);
                    if(this.anchorCharge) listOfSettings.removeChild(this.anchorCharge);
                    if(this.attributeMass) listOfSettings.removeChild(this.attributeMass);
                    if(this.attributeCharge) listOfSettings.removeChild(this.attributeCharge);
                    if(this.tieMass) listOfSettings.removeChild(this.tieMass);
                    if(this.tieCharge) listOfSettings.removeChild(this.tieCharge);
                    if(this.edgeMass) listOfSettings.removeChild(this.edgeMass);
                    if(this.edgeCharge) listOfSettings.removeChild(this.edgeCharge);
                    this.knotMass = null;
                    this.knotCharge = null;
                    this.anchorMass = null;
                    this.anchorCharge = null;
                    this.attributeMass = null;
                    this.attributeCharge = null;
                    this.tieMass = null;
                    this.tieCharge = null;
                    this.edgeMass = null;
                    this.edgeCharge = null;
                }
                else if (value === 'complex') {
                    LayoutEngine.layout = LayoutEngine.complexLayout;
                    this.knotMass = document.createElement('li');
                    this.knotCharge = document.createElement('li');
                    this.anchorMass = document.createElement('li');
                    this.anchorCharge = document.createElement('li');
                    this.attributeMass = document.createElement('li');
                    this.attributeCharge = document.createElement('li');
                    this.tieMass = document.createElement('li');
                    this.tieCharge = document.createElement('li');
                    this.edgeMass = document.createElement('li');
                    this.edgeCharge = document.createElement('li');
                    var knotMassInput = document.createElement('input');
                    var knotChargeInput = document.createElement('input');
                    var anchorMassInput = document.createElement('input');
                    var anchorChargeInput = document.createElement('input');
                    var attributeMassInput = document.createElement('input');
                    var attributeChargeInput = document.createElement('input');
                    var tieMassInput = document.createElement('input');
                    var tieChargeInput = document.createElement('input');
                    var edgeMassInput = document.createElement('input');
                    var edgeChargeInput = document.createElement('input');
                    knotMassInput.setAttribute('type', 'number');
                    knotChargeInput.setAttribute('type', 'number');
                    anchorMassInput.setAttribute('type', 'number');
                    anchorChargeInput.setAttribute('type', 'number');
                    attributeMassInput.setAttribute('type', 'number');
                    attributeChargeInput.setAttribute('type', 'number');
                    tieMassInput.setAttribute('type', 'number');
                    tieChargeInput.setAttribute('type', 'number');
                    edgeMassInput.setAttribute('type', 'number');
                    edgeChargeInput.setAttribute('type', 'number');
                    knotMassInput.setAttribute('step', '0.1');
                    knotChargeInput.setAttribute('step', '0.1');
                    anchorMassInput.setAttribute('step', '0.1');
                    anchorChargeInput.setAttribute('step', '0.1');
                    attributeMassInput.setAttribute('step', '0.1');
                    attributeChargeInput.setAttribute('step', '0.1');
                    tieMassInput.setAttribute('step', '0.1');
                    tieChargeInput.setAttribute('step', '0.1');
                    edgeMassInput.setAttribute('step', '0.1');
                    edgeChargeInput.setAttribute('step', '0.1');
                    knotMassInput.value = NodeType.mass[NodeType.KNOT];
                    knotChargeInput.value = NodeType.charge[NodeType.KNOT];
                    anchorMassInput.value = NodeType.mass[NodeType.ANCHOR];
                    anchorChargeInput.value = NodeType.charge[NodeType.ANCHOR];
                    attributeMassInput.value = NodeType.mass[NodeType.ATTRIBUTE];
                    attributeChargeInput.value = NodeType.charge[NodeType.ATTRIBUTE];
                    tieMassInput.value = NodeType.mass[NodeType.TIE];
                    tieChargeInput.value = NodeType.charge[NodeType.TIE];
                    edgeMassInput.value = NodeType.mass[NodeType.EDGE];
                    edgeChargeInput.value = NodeType.charge[NodeType.EDGE];
                    knotMassInput.addEventListener('blur', function() { NodeType.mass[NodeType.KNOT] = 1 * this.value; }, false);
                    knotChargeInput.addEventListener('blur', function() { NodeType.charge[NodeType.KNOT] = 1 * this.value; }, false);
                    anchorMassInput.addEventListener('blur', function() { NodeType.mass[NodeType.ANCHOR] = 1 * this.value; }, false);
                    anchorChargeInput.addEventListener('blur', function() { NodeType.charge[NodeType.ANCHOR] = 1 * this.value; }, false);
                    attributeMassInput.addEventListener('blur', function() { NodeType.mass[NodeType.ATTRIBUTE] = 1 * this.value; }, false);
                    attributeChargeInput.addEventListener('blur', function() { NodeType.charge[NodeType.ATTRIBUTE] = 1 * this.value; }, false);
                    tieMassInput.addEventListener('blur', function() { NodeType.mass[NodeType.TIE] = 1 * this.value; }, false);
                    tieChargeInput.addEventListener('blur', function() { NodeType.charge[NodeType.TIE] = 1 * this.value; }, false);
                    edgeMassInput.addEventListener('blur', function() { NodeType.mass[NodeType.EDGE] = 1 * this.value; }, false);
                    edgeChargeInput.addEventListener('blur', function() { NodeType.charge[NodeType.EDGE] = 1 * this.value; }, false);
                    this.knotMass.appendChild(knotMassInput);
                    this.knotCharge.appendChild(knotChargeInput);
                    this.anchorMass.appendChild(anchorMassInput);
                    this.anchorCharge.appendChild(anchorChargeInput);
                    this.attributeMass.appendChild(attributeMassInput);
                    this.attributeCharge.appendChild(attributeChargeInput);
                    this.tieMass.appendChild(tieMassInput);
                    this.tieCharge.appendChild(tieChargeInput);
                    this.edgeMass.appendChild(edgeMassInput);
                    this.edgeCharge.appendChild(edgeChargeInput);
                    this.knotMass.appendChild(document.createTextNode(' Knot mass'));
                    this.knotCharge.appendChild(document.createTextNode(' Knot charge'));
                    this.anchorMass.appendChild(document.createTextNode(' Anchor mass'));
                    this.anchorCharge.appendChild(document.createTextNode(' Anchor charge'));
                    this.attributeMass.appendChild(document.createTextNode(' Attribute mass'));
                    this.attributeCharge.appendChild(document.createTextNode(' Attribute charge'));
                    this.tieMass.appendChild(document.createTextNode(' Tie mass'));
                    this.tieCharge.appendChild(document.createTextNode(' Tie charge'));
                    this.edgeMass.appendChild(document.createTextNode(' Edge mass'));
                    this.edgeCharge.appendChild(document.createTextNode(' Edge charge'));
                    listOfSettings.insertBefore(this.edgeCharge, calcsItem);
                    listOfSettings.insertBefore(this.edgeMass, calcsItem);
                    listOfSettings.insertBefore(this.tieCharge, calcsItem);
                    listOfSettings.insertBefore(this.tieMass, calcsItem);
                    listOfSettings.insertBefore(this.attributeCharge, calcsItem);
                    listOfSettings.insertBefore(this.attributeMass, calcsItem);
                    listOfSettings.insertBefore(this.anchorCharge, calcsItem);
                    listOfSettings.insertBefore(this.anchorMass, calcsItem);
                    listOfSettings.insertBefore(this.knotCharge, calcsItem);
                    listOfSettings.insertBefore(this.knotMass, calcsItem);
                }
            }
        };

        // make sure our init function is called when the page is loaded
        window.onload = function() {
            init(this);
        };

        // implementation of our init function
        function init(window) {

            // another disclaimer for the testing versions
            if(!RELEASE) {
                /*alert(
                    '----------- DISCLAIMER -----------\n' +
                    'Please note that this is a test version.\n' +
                    'It should not be used for production \n' +
                    'work. Report bugs found in our issue \n' +
                    'tracking system, to which a link can \n' +
                    'be found under the Help/About menu.\n' +
                    '----------- DISCLAIMER -----------'
                );
                document.getElementById("disclaimer").style.display = "block";*/
            }
            // set values in the settings and defaults input fields

            //Settings.loadSettings(window.localStorage);

            // find any parameters passed in the url
            var gets = window.location.search.substring(1);
            var pair, pairs = gets.split('&');
            for(var i = 0; pair = pairs[i]; i++) {
              pair = pairs[i].split('=');
              PARAMETERS[pair[0]] = pair[1];
            }

            var xmlModel = Actions.xmlFromURL('../api/admin/genAnchorModel');

            var result = Actions.preformat(Sisulator.sisulate(xmlModel, Actions.getDirective(), document));
            //var text = document.createTextNode(xmlModel);
            //document.getElementById("ddlDiv").appendChild(text);
            document.getElementById("ddlDiv").appendChild(result);
            console.log(result)
        }

        // -->
    </script>
</head>
<body>
  <div id="xmlDiv"></div>
  <div id="ddlDiv"></div>
</body>
</html>